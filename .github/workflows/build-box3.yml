# 工作流名称
name: build BOX3 ESPHome

# 触发条件
on:
  workflow_dispatch:  # 手动触发（推荐）

jobs:
  compile-esphome:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取仓库代码
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 步骤2：配置 Python 环境
      - name: 配置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 步骤3：安装 ESPHome（移除缓存，每次都正常安装，避免 command not found）
      - name: 安装 ESPHome
        run: |
          python -m pip install --upgrade pip
          pip install esphome

      # 步骤4：编译ESP32-S3-BOX-3固件
      - name: 编译固件
        run: |
          # 进入配置文件目录
          cd esp32-s3-box-3
          # 编译固件，生成bin文件（--no-logs减少日志输出，--verbose便于排查错误）
          esphome compile esp32-s3-box-3.factory.yaml

      # 步骤5：查找编译好的固件文件并打包
      - name: 打包固件文件
        run: |
          # 创建固件输出目录
          mkdir -p firmware-output
          # 查找编译后的bin文件（ESPHome编译产物默认在.build目录）
          find . -name "*.bin" -path "*/esp32-s3-box-3/.build/*" -exec cp {} firmware-output/ \;
          # 复制配置文件到输出目录（便于核对）
          cp esp32-s3-box-3/esp32-s3-box-3.factory.yaml firmware-output/
          # 列出输出目录文件，确认固件已复制
          ls -l firmware-output/

      # 步骤6：上传固件作为Artifacts（核心：支持下载）
      - name: 上传固件到Artifacts
        uses: actions/upload-artifact@v4
        with:
          # Artifact名称（下载时显示的名称）
          name: ESP32-S3-BOX-3固件-${{ github.sha }}
          # 要上传的文件目录（包含编译好的bin和配置文件）
          path: firmware-output/
          # 保留时间：90天（默认90天，可修改，如14天）
          retention-days: 30